//TODO
/*
	object template?
	random draw
	token and currency
	justify money enough
	preserve card
	royal left to next commit

	card template
	{type:"Diamond",score:1,price:{token}}
*/
	

//var Deck = require("./Splendor.js")();
var Deck = {
bot:
[
{price:{Diamond:0,Sapphire:3,Emerald:0,Ruby:0,Agate:0},score:0,type:"Diamond"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:2,Agate:1},score:0,type:"Diamond"},
{price:{Diamond:0,Sapphire:1,Emerald:1,Ruby:1,Agate:1},score:0,type:"Diamond"},
{price:{Diamond:0,Sapphire:2,Emerald:0,Ruby:0,Agate:2},score:0,type:"Diamond"},
{price:{Diamond:0,Sapphire:0,Emerald:4,Ruby:0,Agate:0},score:1,type:"Diamond"},
{price:{Diamond:0,Sapphire:1,Emerald:2,Ruby:1,Agate:1},score:0,type:"Diamond"},
{price:{Diamond:0,Sapphire:2,Emerald:2,Ruby:0,Agate:1},score:0,type:"Diamond"},
{price:{Diamond:3,Sapphire:1,Emerald:0,Ruby:0,Agate:1},score:0,type:"Diamond"},
{price:{Diamond:1,Sapphire:0,Emerald:0,Ruby:0,Agate:2},score:0,type:"Sapphire"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:0,Agate:3},score:0,type:"Sapphire"},
{price:{Diamond:1,Sapphire:0,Emerald:1,Ruby:1,Agate:1},score:0,type:"Sapphire"},
{price:{Diamond:0,Sapphire:0,Emerald:2,Ruby:0,Agate:2},score:0,type:"Sapphire"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:4,Agate:0},score:1,type:"Sapphire"},
{price:{Diamond:1,Sapphire:0,Emerald:1,Ruby:2,Agate:1},score:0,type:"Sapphire"},
{price:{Diamond:1,Sapphire:0,Emerald:2,Ruby:2,Agate:0},score:0,type:"Sapphire"},
{price:{Diamond:0,Sapphire:1,Emerald:3,Ruby:1,Agate:0},score:0,type:"Sapphire"},
{price:{Diamond:2,Sapphire:1,Emerald:0,Ruby:0,Agate:0},score:0,type:"Emerald"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:3,Agate:0},score:0,type:"Emerald"},
{price:{Diamond:1,Sapphire:1,Emerald:0,Ruby:1,Agate:1},score:0,type:"Emerald"},
{price:{Diamond:0,Sapphire:2,Emerald:0,Ruby:2,Agate:0},score:0,type:"Emerald"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:0,Agate:4},score:1,type:"Emerald"},
{price:{Diamond:1,Sapphire:1,Emerald:0,Ruby:1,Agate:2},score:0,type:"Emerald"},
{price:{Diamond:0,Sapphire:1,Emerald:0,Ruby:2,Agate:2},score:0,type:"Emerald"},
{price:{Diamond:1,Sapphire:3,Emerald:1,Ruby:0,Agate:0},score:0,type:"Emerald"},
{price:{Diamond:0,Sapphire:2,Emerald:1,Ruby:0,Agate:0},score:0,type:"Ruby"},
{price:{Diamond:3,Sapphire:0,Emerald:0,Ruby:0,Agate:0},score:0,type:"Ruby"},
{price:{Diamond:1,Sapphire:1,Emerald:1,Ruby:0,Agate:1},score:0,type:"Ruby"},
{price:{Diamond:2,Sapphire:0,Emerald:0,Ruby:2,Agate:0},score:0,type:"Ruby"},
{price:{Diamond:4,Sapphire:0,Emerald:0,Ruby:0,Agate:0},score:1,type:"Ruby"},
{price:{Diamond:2,Sapphire:1,Emerald:1,Ruby:0,Agate:1},score:0,type:"Ruby"},
{price:{Diamond:2,Sapphire:0,Emerald:1,Ruby:0,Agate:2},score:0,type:"Ruby"},
{price:{Diamond:1,Sapphire:0,Emerald:0,Ruby:1,Agate:3},score:0,type:"Ruby"},
{price:{Diamond:0,Sapphire:0,Emerald:2,Ruby:1,Agate:0},score:0,type:"Agate"},
{price:{Diamond:0,Sapphire:0,Emerald:3,Ruby:0,Agate:0},score:0,type:"Agate"},
{price:{Diamond:1,Sapphire:1,Emerald:1,Ruby:1,Agate:0},score:0,type:"Agate"},
{price:{Diamond:2,Sapphire:0,Emerald:2,Ruby:0,Agate:0},score:0,type:"Agate"},
{price:{Diamond:0,Sapphire:4,Emerald:0,Ruby:0,Agate:0},score:1,type:"Agate"},
{price:{Diamond:1,Sapphire:2,Emerald:1,Ruby:1,Agate:0},score:0,type:"Agate"},
{price:{Diamond:2,Sapphire:2,Emerald:0,Ruby:1,Agate:0},score:0,type:"Agate"},
{price:{Diamond:0,Sapphire:0,Emerald:1,Ruby:3,Agate:1},score:0,type:"Agate"}
],
mid:
[
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:5,Agate:0},score:2,type:"Diamond"},
{price:{Diamond:6,Sapphire:0,Emerald:0,Ruby:0,Agate:0},score:3,type:"Diamond"},
{price:{Diamond:0,Sapphire:0,Emerald:3,Ruby:2,Agate:2},score:1,type:"Diamond"},
{price:{Diamond:0,Sapphire:0,Emerald:1,Ruby:4,Agate:2},score:2,type:"Diamond"},
{price:{Diamond:2,Sapphire:3,Emerald:0,Ruby:3,Agate:0},score:1,type:"Diamond"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:5,Agate:3},score:2,type:"Diamond"},
{price:{Diamond:0,Sapphire:5,Emerald:0,Ruby:0,Agate:0},score:2,type:"Sapphire"},
{price:{Diamond:0,Sapphire:6,Emerald:0,Ruby:0,Agate:0},score:3,type:"Sapphire"},
{price:{Diamond:0,Sapphire:2,Emerald:2,Ruby:3,Agate:0},score:1,type:"Sapphire"},
{price:{Diamond:2,Sapphire:0,Emerald:0,Ruby:1,Agate:4},score:2,type:"Sapphire"},
{price:{Diamond:0,Sapphire:2,Emerald:3,Ruby:0,Agate:3},score:1,type:"Sapphire"},
{price:{Diamond:5,Sapphire:3,Emerald:0,Ruby:0,Agate:0},score:2,type:"Sapphire"},
{price:{Diamond:0,Sapphire:0,Emerald:5,Ruby:0,Agate:0},score:2,type:"Emerald"},
{price:{Diamond:0,Sapphire:0,Emerald:6,Ruby:0,Agate:0},score:3,type:"Emerald"},
{price:{Diamond:2,Sapphire:3,Emerald:0,Ruby:0,Agate:2},score:1,type:"Emerald"},
{price:{Diamond:3,Sapphire:0,Emerald:2,Ruby:3,Agate:0},score:1,type:"Emerald"},
{price:{Diamond:4,Sapphire:2,Emerald:0,Ruby:0,Agate:1},score:2,type:"Emerald"},
{price:{Diamond:0,Sapphire:5,Emerald:3,Ruby:0,Agate:0},score:2,type:"Emerald"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:0,Agate:5},score:2,type:"Ruby"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:6,Agate:0},score:3,type:"Ruby"},
{price:{Diamond:2,Sapphire:0,Emerald:0,Ruby:2,Agate:3},score:1,type:"Ruby"},
{price:{Diamond:1,Sapphire:4,Emerald:2,Ruby:0,Agate:0},score:2,type:"Ruby"},
{price:{Diamond:0,Sapphire:3,Emerald:0,Ruby:2,Agate:3},score:1,type:"Ruby"},
{price:{Diamond:3,Sapphire:0,Emerald:0,Ruby:0,Agate:5},score:2,type:"Ruby"},
{price:{Diamond:5,Sapphire:0,Emerald:0,Ruby:0,Agate:0},score:2,type:"Agate"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:0,Agate:6},score:3,type:"Agate"},
{price:{Diamond:3,Sapphire:2,Emerald:2,Ruby:0,Agate:0},score:1,type:"Agate"},
{price:{Diamond:0,Sapphire:1,Emerald:4,Ruby:2,Agate:0},score:2,type:"Agate"},
{price:{Diamond:3,Sapphire:0,Emerald:3,Ruby:0,Agate:2},score:1,type:"Agate"},
{price:{Diamond:0,Sapphire:0,Emerald:5,Ruby:3,Agate:0},score:2,type:"Agate"}
],
top:
[
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:0,Agate:7},score:4,type:"Diamond"},
{price:{Diamond:3,Sapphire:0,Emerald:0,Ruby:0,Agate:7},score:5,type:"Diamond"},
{price:{Diamond:3,Sapphire:0,Emerald:0,Ruby:3,Agate:6},score:4,type:"Diamond"},
{price:{Diamond:0,Sapphire:3,Emerald:3,Ruby:5,Agate:3},score:3,type:"Diamond"},
{price:{Diamond:7,Sapphire:0,Emerald:0,Ruby:0,Agate:0},score:4,type:"Sapphire"},
{price:{Diamond:7,Sapphire:3,Emerald:0,Ruby:0,Agate:0},score:5,type:"Sapphire"},
{price:{Diamond:6,Sapphire:3,Emerald:0,Ruby:0,Agate:3},score:4,type:"Sapphire"},
{price:{Diamond:3,Sapphire:0,Emerald:3,Ruby:3,Agate:5},score:3,type:"Sapphire"},
{price:{Diamond:0,Sapphire:7,Emerald:0,Ruby:0,Agate:0},score:4,type:"Emerald"},
{price:{Diamond:0,Sapphire:7,Emerald:3,Ruby:0,Agate:0},score:5,type:"Emerald"},
{price:{Diamond:3,Sapphire:6,Emerald:3,Ruby:0,Agate:0},score:4,type:"Emerald"},
{price:{Diamond:5,Sapphire:3,Emerald:0,Ruby:3,Agate:3},score:3,type:"Emerald"},
{price:{Diamond:0,Sapphire:0,Emerald:7,Ruby:0,Agate:0},score:4,type:"Ruby"},
{price:{Diamond:0,Sapphire:0,Emerald:7,Ruby:3,Agate:0},score:5,type:"Ruby"},
{price:{Diamond:0,Sapphire:3,Emerald:6,Ruby:3,Agate:0},score:4,type:"Ruby"},
{price:{Diamond:3,Sapphire:5,Emerald:3,Ruby:0,Agate:3},score:3,type:"Ruby"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:7,Agate:0},score:4,type:"Agate"},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:7,Agate:3},score:5,type:"Agate"},
{price:{Diamond:0,Sapphire:0,Emerald:3,Ruby:6,Agate:3},score:4,type:"Agate"},
{price:{Diamond:3,Sapphire:3,Emerald:5,Ruby:3,Agate:0},score:3,type:"Agate"}
],
nobel:
[
{price:{Diamond:3,Sapphire:3,Emerald:0,Ruby:0,Agate:3},score:3},
{price:{Diamond:0,Sapphire:3,Emerald:3,Ruby:3,Agate:0},score:3},
{price:{Diamond:3,Sapphire:0,Emerald:0,Ruby:3,Agate:3},score:3},
{price:{Diamond:0,Sapphire:0,Emerald:4,Ruby:4,Agate:0},score:3},
{price:{Diamond:0,Sapphire:4,Emerald:4,Ruby:0,Agate:0},score:3},
{price:{Diamond:0,Sapphire:0,Emerald:0,Ruby:4,Agate:4},score:3},
{price:{Diamond:4,Sapphire:0,Emerald:0,Ruby:0,Agate:4},score:3},
{price:{Diamond:3,Sapphire:3,Emerald:3,Ruby:0,Agate:0},score:3},
{price:{Diamond:0,Sapphire:0,Emerald:3,Ruby:3,Agate:3},score:3},
{price:{Diamond:4,Sapphire:4,Emerald:0,Ruby:0,Agate:0},score:3}
]
};



exports = module.exports = function createGame()

{
	token = () => {return {Emerald:0,Sapphire:0,Ruby:0,Diamond:0,Agate:0,Gold:0}}
	user = (index) => {return {index:index,token:token(),score:0,currency:token()}}
	const win = 15;
	var cur_card = {top:[],mid:[],bot:[],nobel:[]};


	var users = [user(0),user(1),user(2),user(3)];
	//cur_user = 4 for win
	var cur_user = 0;

	var cur_token = {Emerald:7,Sapphire:7,Ruby:7,Diamond:7,Agate:7,Gold:5};
	var deck = Deck;


	var next_turn = () => {return (cur_user===3)? 0:++cur_user;};
	var get_cur_card = () => {return cur_card;};
	var get_cur_token = () => {return cur_token;};

	var init_draw = () => {
		cur_card = {
			top:[draw_card("top"),draw_card("top"),draw_card("top"),draw_card("top")],
			mid:[draw_card("mid"),draw_card("mid"),draw_card("mid"),draw_card("mid")],
			bot:[draw_card("bot"),draw_card("bot"),draw_card("bot"),draw_card("bot")],
			nobel:[draw_card("nobel"),draw_card("nobel"),draw_card("nobel"),draw_card("nobel"),draw_card("nobel")],
		}
	};

	//TODO front_end render no card(null)
	var take_card = (pos,index,price) => {
		checkout(cur_card[pos][index]);
		score(cur_card[pos][index]);
		cur_card[pos][index] = draw_card(pos);
		token_back(price);
	};
	//do server need to know price?
	var checkout = (card) => {
		if(card.type!=='none')
		users[cur_user].currency[card.type] += 1;
	};

	var score = (card) => {
		users[cur_user].score += card.score;
		if(users[cur_user].score>win){
			cur_user = 4;
		}
	};


	var draw_card = (where) => {
		if(deck[where].length===0)return;
		const rand = Math.floor(Math.random()*deck[where].length);
		const target = deck[where][rand];
		deck[where][rand] = deck[where][deck[where].length-1];
		deck[where].pop();
		return target;
	};

	var take_token = (kind1,kind2,kind3) => {
		if(kind2) {
			cur_token[kind1] -= 1;users[cur_user].token[kind1]+=1;
			cur_token[kind2] -= 1;users[cur_user].token[kind2]+=1;
			cur_token[kind3] -= 1;users[cur_user].token[kind3]+=1;

		}
		else {
			cur_token[kind1] -= 2;users[cur_user].token[kind1]+=2;
		}

	};

	var token_back = (price) => {
		for(var key in price){
			users[cur_user].token[key] -= price[key];
			cur_token[key] += price[key];
		}
	};


	//return method
	return {
		init_draw:init_draw,
		next_turn:next_turn,
		get_cur_card:get_cur_card,
		get_cur_token:get_cur_token,
		take_card:take_card,
		checkout:checkout,
		score:score,
		draw_card:draw_card,
		take_token:take_token

	}

	


}